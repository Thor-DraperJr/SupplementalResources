# AZ-500 Study Sessions

## Configure AAD for work
### Create App Registration
App registration (AAD Premium P2, Global Admin):
- this application can bu authorized an used by users
- any user who is a member of the AD can register an app(not a guest user)
 - an equivalent of adding a workstation to a domain

* AAD - contains a unique tenant ID
1. Navigate the left pane to App registration
2. New Registration
    * Name
    * Single tenant = default [Any Azure AD - Multitenant/ + personal Microsoft]
    * Redirect URI (optional)
        * Web = default (used for most authentication scenarios. mandates https)
3. Register

* ISV: independent software vendor

### Configure App Registration permission scopes
#### Terms
* scoping
* delegated permisstions = app interacts with a signed in user and binds proper constraints
* OAuth 2.0 = permissions are called scope

- In the left pane for Authentication it allows you to manage URI's for redirects

API permissions = Configured permissions

Microsoft Graph is the default microsoft provided permission to 'Sign in and read user profile', can be removed but shouldn't.

Adding an API permission
Options: Microsoft APIs, 
Supported legacy apps are on the bottom

Types of permissions: Delegated permissions (The application assumes the persona of the user to behave on behalf of the user) / Application permissions (no signed in users needed)

### Manage App Resgistration permission consent
proves right person to right level of access. 

Grants consent on behalf of the users in the AADD

**Tip:** https://myapps.microsoft.com

### Configure Multi-Factor Authentication security
* Security > Left pane, under the Manage subsection
* Click MFA
    * Account Lockout - specify locoucks for too man denials in a row that only applies to users who enter a PIN to authenticate
        * number of denials to trigger, minute s until rest, minutes until account is unblocked
    * Block/unblock users
        * Adding a user - prevents them from receiving the MFA prompt (auto blocked for 90 days)
    * Fraud Alert - allows user to report fraud if they receive a two-step verification request
        * Default is off
    * Notifications - the global admin is automatically listed
        * One-time bypass = a temporary allow for a user to authenticate for a default time period [default is 300 seconds - 5 min.]
        * Activity report = can see who has activated and usage logs
    * in the security section > Named locations > Configure MFA IPs
        * allows for whitelisting internal IPs
        * allows for remembering MFA for a set amount of days for trusted devices

### Manage Azure AD directory groups
* two-stage deletion process
* export capability
* naming convention controls

* types of groups: security, distribution, Office365, on-prem

**can only manage on-prem ON-PREM**

Navigate to AAD > Manage > Groups
* In groups
    * Settings
        * General
            * Self Service Group Management - owners can manage membership request in the access panel
            * Security Groups
            * Office 365 Groups
            * Directory-wide Groups
        * Expiration
            * useful for business cycles or project driven needs to timebound a group
            * Group lifetime (in days)
            * Notification for expiration reminders hapen 30, 15, 1 day (email only)
            * if not renewed the group is deleted
        * Naming policy
            * Blocked words - .csv of banned words (profanity, internal anames) and upload the csv
            * Group naming policy - unique only to Office 365 groups
                * add prefix / add suffix
    * Bulk operation results
        * you can export all groups from the main group page
        * hosts the results where you can download in a csv
        * does not contain memberships
        * useful for auditing what groups exists / automation

#### Deleting groups
- You can initially delete from the group list
- Navigate to Deleted groups 
    - You can Delete permanently or restore
    - Groups are held in delete for 30 days

#### Managing Licenses
- Choose a Security Group
    - Licenses
        - You can select licenses and services you want to enable or disable

### Manage Azure AD Users
- Roles and administrators
    - how you give and assign users roles and delegated rights

#### User v Guest User
- User = Known as members [Internal accounts]
    - Either AAD or Windows Server AD
- Guest Users = outside of the organization (contractors, end-users)
    - Invited User
    - Can be created or invited
        - creating a new user in the org will allow you to create and apply a domain (say you need it for multiple business units to give access to named directories). you can reset passwords
        - inviting a user creates the account as the invite is sent

#### Deleting a User
- You need to go into the username from the menu
- Deleted users go into the 'Deleted users' option
    - can be permanently delted or restored (30 day)

#### Password Reset
- You can enable 'Self service passwords'
    - Apply to end users in your oganization
    - Admins auto-enrolled
    - require two methods of verification

#### User Settings
- Admin portal
- LinkedIn Account SSO

#### Roles and Administators
- Assignments : allow you to choose users (like application admin or application developer)

*you can manage licenses to users the same way*

### Install and Configure Azure AD Connect
* AD Connect tool
    * Express Install - requires a routable (.com) domain
        * Customize Install
            * Specify a custom installation location = Default is C:\Program Files\Microsoft
        * User sign-in
        * Connecting to Azure AD = Requires Global admin credentials
* For SSO Create a GPO
    * Site to Zone Assignment List > Edit to enable
        * https://autologon.microsoftazuread-sso.com | Data: 1

    * **Tip** Must be 2012 or newer
    * Ideally domain joined not the DC

### Configure Authentication Methods
* Do you want Azure AD to handle Sign-in COMPLETELY in the cloud?

* Hash sychronize is a big factor in between on-prem / cloud envirnements because both environments need to sychronize for changes

* You can add multiple authentication methods

* Seamless SSO = allows users to us the same credentials to access other Azure resources

* Pass-through = No integrated federation, no 

##### Define the options after looking into the portal****

### Implement Conditional Access policies
* Conditional access
    * signals - users, endpoint type OS 
    * decisions - what you grant to the user

* AAD
    * Security > Conditional Access | Policies
        * Policy types: 
            * Baseline - msft defaults
            * Standard - admin created and modified
            * Classic - legacy policies

While creating policies the default is to Report-only to see how policies would be applied.

### Configure Azure AD Identity protection
In Azure AD - Premium P2 > Security > Identity Protection

* Overview
    * Scorecard data
        * Contains 90 days of historical data
    * New Risky sign-ins
        * Relation to baseline/standard policies

* Protect | Sign-in risk policy
    * Assign Users
    * Conditions
        * risk level
    * Controls
        * Block, allow
        * Require MFA
    * Enforce the Policy or not for users

* Leaked credentials - if your credentials show up on an online db [dark web id?]

* Notify | 
    * add additional users

*Global Admin isn't the only account that has access to this tab. Global reader, security reader and others are able to view Identity Protection(good fit for cso)*

## Configure Azure AD Priveleged Identity Management

### Activate Privileged Identity Management

Search Azure AD Priveleged Identity Managment (launches the blade)

PIM allos JIT (just in time) management. To give a fixed amount of time (ex. a business day) Time bounding use of time

RBAC

security admin
priveleged administrator role


* Tasks
    * My roles
    * My requests
    * Approve Requests
    * Review access
* Manage 
    * Azure AD roles
        * *Sign up = create/assins necessary roles and signs them up to the user initializing*
        *
    * Azure resources
        * where you can manage resouces outside of AD
* Activity
    * My audit history-

### Monitor Privieleged Access
- Licensing
    - Premium P2, E5 (ERM brings P2)
    - roles every administrator other than global admins needs a license for PIM
    - users managed by PIM need it, approvers need it, and reviewers need it
    - Users assigned as eligible to Azure AD roles managed using PIM
    - Users able to approve or reject activation requests in PIM
    - Users assigned to an Azure resource role with just-in-time or direct

The top 10 Azure AD roles managed by Privileged Identity Management are:

1. Global administrator
2. Security administrator
3. User administrator
4. Exchange administrator
5. SharePoint administrator
6. Intune administrator
7. Security reader
8. Service administrator
9. Billing administrator
10. Skype for Business administrator


PIM emails for Azure resource roles - Privileged Identity Management sends emails to Owners and User Access Administrators when the following events occur for Azure resource roles:

* When a role assignment is pending approval
* When a role is assigned
* When a role is soon to expire
* When a role is eligible to extend
* When a role is being renewed by an end user
* When a role activation request is completed

Privileged Identity Management sends emails to end users when the following events occur for Azure resource roles:

* When a role is assigned to the user
* When a user's role is expired
* When a user's role is extended
* When a user's role activation request is completed

### Configure Access Reviews

* Prerequistes
    * Azure AD Premium P2
    * Global admin or User admin

Navigate to Azure AD > Identity Governance
* Access reviews
    * Access reviews
        * Create an access review
            * Review name*
            * Description
            * Start date*
            * Frequency
            * End [Never, End by, Occurances]
            * Users
            * Scope - *You would need to create two if you wanted to audit both groups*
                * Guests
                * Everyone (does not include Guests)

Reviews are hosted at myaccess.microsoft.com

## Configure Azure tenant security

### Transfer Azure subs between Azure AD tenants
Navigate to 'Cost Management + Billing' 

* Billing
    * Subscriptions - In the options you can hit the elipses

You do this by emailing the subscription. You can change billing admins not necessarirly the entire tenant.

This removes RBAC permissions to manage Azure resources in the subscription

### Manage API access Azure subscriptions and resources

Authentication and Authorization steps

#### OAuth 2.0
The basic steps required to use the OAuth 2.0 authorization code grant flow to get an access token from the Microsoft identity platform endpoint are:

1. Register your app with Azure AD
2. Get authorization (/authorize endpoint) & Consent Experience
3. Get an access token (/token endpoint)
4. Call Microsoft Graph with the access token
5. Use a refresh token to get a new access token

## Implement network security

### Configure virtual netowrk connectivity
* Virtual network access settings are enabled by default and traffic forwarding is disabled
* Have to add IPv6 if you want that address space

Access to cloud shell
* shell.azure.com
    * editor is similar to ISE

### Create & Configure Network & Application Security Groups
* Network Security Groups (NSG) - uses security rules [similar to access control lists], manages stateful traffic/stateful filtering
    * managed rules for connections to the vnet
    * NSGs manage:
        * protocol - tcp, udp, icmp or any
        * direction - inbound or outbound
        * port range
        * action - allow or deny

* 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic.

### Create NSGs and ASGs
1. create a vnet
2. create ASG
3. create NSG
4. associate network sec group to subnet
5. create sec rule
6. create vms
7. associate network interfaces to asg

* Defualts
    * AllowVnetInBound
    * AllowAllowLoadBalancer
    * DenyAllInBound

### Create and configure Azure Firewall
* Firewall solution (Firewall as a Service)
* Scalable solution

* tied into log analytics, has it's own public IP, integrate with SEIM (sec incident and management)

Azure Firewall is a managed, cloud-based network security service that protects your Azure Virtual Network resources. It is a fully stateful firewall as a service with built-in high availability and unrestricted cloud scalability.

You can centrally create, enforce, and log application and network connectivity policies across subscriptions and virtual networks. Azure Firewall uses a static public IP address for your virtual network resources allowing outside firewalls to identify traffic originating from your virtual network. The service is fully integrated with Azure Monitor for logging and analytics.

* Stadard SKU Public IP and Static only

* Forced Tunneling : 

* Threat intelligence - off, alert only, alert and deny

* Rules - NAT Rule collection | Network rule collection | Application rule collection

### Configure resource Firewall
The *resource firewall* allows us to restrict access to an Azure service that supports the resource firewall feature. Azure storage accounts are one area where that is supported, as are Azure SQL Server and databases as well as Azure SQL Data Warehouse. In fact for Azure SQL, you can actually configure firewall rules at both the server level and the database level. You can use PowerShell, Azure CLI and the Azure Portal.

The *Azure storage firewall* provides access control for the public endpoint of your storage account. You can also use the firewall to block all access through the public endpoint when using private endpoints. Your storage firewall configuration also enables select trusted Azure platform services to access the storage account securely.

An application that accesses a storage account when network rules are in effect still requires proper authorization for the request. Authorization is supported with Azure Active Directory (Azure AD) credentials for blobs and queues, with a valid account access key, or with a SAS token.

* Object bound instances - specify vnet, subnet, address range, endpoint status, rg. You specify stateful connections in and out.

### Create and Configure Azure Front Door service
Azure Front Door Service enables you to define, manage, and monitor the global routing for your web traffic by optimizing for best performance and instant global failover for high availability.

Front Door works at **Layer 7** or HTTP/HTTPS layer and uses anycast protocol with split TCP and Microsoft's global network for improving global connectivity. So, per your routing method selection in the configuration, you can ensure that Front Door is routing your client requests to the fastest and most available application backend.

An application backend is any Internet-facing service hosted inside or outside of Azure.

* HA for web apps

#### Features of Front Door
* accelerate application performance
* increase application availibility with smart health probes
* url-based routing
* multi-site hosting
* session affinity
* ssl termination
* custom domains and cert management
* application layer security
* url redirection
* url rewrite
* protocol support

#### Setting up front door
* <hostname>.azurefd.net

* Setting up a frontend
    * Session Affinity, Web Application Firewall - disabled by default
* Setting up the backend pools
    * backed unique web app names **azurewebsites.net**
* A routing rule maps your frontend host to the backend pool. The rule forwards a request for contoso-frontend.azurefd.net to myBackendPool.

### Configure remote access management
* A virtual network gateway is composed of two or more VMs that are deployed to a specific subnet you create called the gateway subnet. Virtual network gateway VMs contain routing tables and run specific gateway services.

* Gateway types - VPN, ExpressRoute
    * VPN - from on prem to azure (Site 2 Site)
        *  SKUs named and number (ex. VpnGw1 - VpnGw5), higher the more expensive. Basic is also a SKU but can only be a Generation1.

    * Express Route - dedicated connectivity through an ISP

* Adding a Connection
    * Connection Type
        * VNet-to-VNet
        * Site-to-site (IPsec)
        * Express Route
    * Shared key (PSK)*
    * First VNG
    * Second VNG

* Point-to-site
    * Address pool - must be unique
    * Tunnel type
    * Authentication type

// A drawing would be nice

### Configure baseline
What is Azure Policy? -

Azure Policy helps to enforce organizational standards and to assess compliance at-scale. Through its compliance dashboard, it provides an aggregated view to evaluate the overall state of the environment, with the ability to drill-down to the per-resource, per-policy granularity. It also helps to bring your resources to compliance through bulk remediation for existing resources and automatic remediation for new resources.

* Baselining isn't an option - it's a combination of following best practices. Leveraging azure policy to do so

* After creating a policy you can assign a policy

* Definitions : looking at existing elements or create new
    * location = subscription

## Implement host security

### Configure endpoint security within the VM
* Protect VMs by using authentication and access control
* use multiple vms for better availability
* protect agains malware
* manage your vm updates
* manage your vm security posture
* monitor vm performance
* encrypt your virtual hard disk files
* restrict direct internet connectivty

- Share responsibility to ASC

- Detail: Use a least privilege approach and built-in Azure roles to enable users to access and set up VMs:
    - Virtual Machine Contributor: Can manage VMs, but not the virtual network or storage account to which they are connected.

### Configure VM security & Configure baseline
Configuring the baseline is about going from the "as-is" to the "to be"

### Configure system updates for VMs in Azure

## Configure container security

### Configure networking
* choose the appropriate network model
    * kubenet vs. azure CNI networking
* Distribute ingress traffic
    * An ingress resource & an ingress controller
* Secure traffic with a web application firewlall (WAF)
* Control traffic flow with network policies
    * Azure vs. Calico
* Securely connect to nodes through a bastion host

### Configure authentication
Security best practices for AKS authentication
* use azure active directory
    * roles or clusterroles bound to users
* use role-based access controls (RBAC)
    * Permissions can be defined at the lcuster level, or to specific namespaces
* Use Pod Identities
    * the node magement identity (NMI) server : listens for pod requrest to Azure services
    * the managed identity controller (MIC) : checks for an azure identity mapping that corresponds to a pod

### Configure container isolation
As you manage clusters in Azure Kubernetes Service (AKS), you often need to isolate teams and workloads. The Kubernetes scheduler provides features that let you control the distribution of compute resources, or limit the impact of maintenance events.

Resource requests and limits are placed in the pod specification. These limits are used by the Kubernetes scheduler at deployment time to find an available node in the cluster. These limits and requests work at the individual pod level.

Best practice guidance - Plan and apply resource quotas at the namespace level. If pods do not define resource requests and limits, reject the deployment. Monitor resource usage and adjust quotas as needed.

Best practice guidance - To maintain the availability of applications, define Pod Disruption Budgets (PDBs) to make sure that a minimum number of pods are available in the cluster.
* Involuntary disruptions are events beyond the typical control of the cluster
* Voluntary disruptions are events requested by the cluster operator

Cluster networking
* public: URI = ".westus2.azurecontiner.io"
* private:
* none